# FAT12

## FAT12 文件系统
FAT12 文件系统的历史相当久远，早在 DOS 系统的时代就使用 FAT12 作为文件系统使用，一直沿用至今仍会在软盘的结构上使用 FAT12 格式。

当软盘以 FAT12 格式组织格式化后将会以如下标准设定：

两个磁头；
每个磁头有 80 个磁道；
每个磁道有 18 个扇区；
每个扇区大小为 512 字节。
标准 FAT12 软盘空间：2 * 80 * 18 * 512 = 1474560B = 1440KB = 1.44MB

因此一个标准的 1.44MB 大小的 FAT12 格式软盘共有 2 * 80 * 18 = 2880 个扇区。这 2880 个扇区被分为 5 个部分，如下：

![在这里插入图片描述](https://img-blog.csdnimg.cn/b2519b9ab7874519bda1a6c7294a4fa6.png#pic_center)

## MBR (Main Boot Record)

`MBR (Main Boot Record)` 主引导记录占用大小为 `1` 个扇区，即 `512 B`。在这个扇区里记录了整个文件系统的组织结构信息和引导程序两部分内容。

|标识|偏移量|类型|大小|默认值|描述|
|---|---|---|---|---|---|
|BS_JmpBoot|0|db|3|-|跳转指令|
|BS_OEMName|3|db|8|MSWIN4.1|OEM字符串，必须为 8 个字符，不足需以空格填充|
|BPB_BytePerSec|11|dw|2|0x200|每个扇区字节数|
|BPB_SecPerClus|12|db|1|1|每簇占用的扇区数|
|BPB_RsvdSecCnt|14|dw|2|1|Boot占用的扇区数|
|BPB_NumFATs|16|db|1|2|FAT表的数量|
|BPB_RootEntCnt|17|dw|2|0xE0|根目录可容纳的目录项数|
|BPB_TotSec16|19|dw|2|0xB40|逻辑扇区总数|
|BPB_Media|21|db|1|0xF0|媒体描述符|
|BPB_FATSz16|22|dw|2|9|每个FAT占用扇区数|
|BPB_SecPerTrk|24|dw|2|0x12|每个磁道扇区数|
|BPB_NumHeads|26|dw|2|2|磁头数|
|BPB_HiddSec|28|dd|4|0|隐藏扇区数|
|BPB_TotSec32|32|dd|4|0|若BPB_TotSec16是0，则在这里记录扇区总数|
|BS_DrvNum|36|db|1|0|中断 13(int 13h)的驱动器号|
|BS_Reserved1|37|db|1|0|未使用|
|BS_Bootsig|38|db|1|0x29|扩展引导标志|
|BS_VolID|39|dd|4|0|卷序列号|
|BS_VolLab|43|db|11|-|卷标，必须为11个字符，不足会以空格填充|
|BS_FileSysType|54|db|8|FAT12|文件系统类型，必须是8个字符，不足以空格填充|
|BOOT_Code|62|db|448|0x00|引导代码，由偏移0字节(BS_JmpBoot)跳转过来|
|END|510|db|2|0x55, 0xAA|系统引导标识，引导扇区结束标识|

BPB_NumFATs： 描述在存储介质中 FAT 表的数量。此处虽然规定最小设置的值为 1，但是为了能够起到恢复文件的作用，一般建议设置为 2，即表示拥有两份 FAT 表。

BPB_Media： 描述存储介质类型，对于不可移动的存储介质，标准值为 0xF8，对于可移动的存储介质，常用值为 0xF0。该字段的合法值有 0xF0、0xF8、0xF9、0xFA、0xFB、0xFC、0xFD、0xFE、0xFF。此处写入的值也必须向 FAT 的第 0 项的最后一个字节写入同样的值。



## FAT 表
本文采用两个 FAT 表格式的 FAT12 文件系统，由于 FAT2 是用于数据恢复作用，因此 FAT2 的内容与 FAT1 表的内容完全相同，即是拷贝了 FAT1 一份。

FAT12 文件系统以簇 (Cluster) 为单位分配数据区（管理扇区），每个簇大小为 BPB_NumFATs * BPB_RootEntCnt 个字节。

FAT 表中的表项位宽与 FAT 类型有关，FAT12 文件系统的表项位宽为 12bit，FAT16 的表项位宽为 16bit，而 FAT32 的表项位宽为 32bit。FAT 表中的表项与数据区的簇是一一对应的关系，即一个表项对应数据区的一个簇大小的内存单元。

FAT 表项的取值如下：

|FAT 项|可取值|描述|
|---|---|---|
|0|BPB_Media|磁盘标识字，低字节需与 BPB_Media 数值保持一致|
|1|FFFh|表示第一个簇已占用|
|2 ~ N|000h|可用簇|
|2 ~ N|002h~FEFh|已用簇|
|2 ~ N|FF0h~FF6h|保留簇|
|2 ~ N|FF7h|坏簇|
|2 ~ N|FF8h~FFFh|文件的最后一个簇|

[注]：FAT[0] 和 FAT[1] 始终不作为数据区的索引使用。



## 根目录和数据区

根目录区只保存目录项 (`BootEntry`) 信息，数据区的不仅可以保存目录项信息，也可以保存文件数据。目录项是由一个 `32B` 组成的结构体，目录项本身可以表示一个目录，也可以表示一个文件，其中记录着名字、长度 以及数据起始簇号等信息。其完整结构如下：

| 名称         | 偏移 | 长度 | 描述                 |
| ------------ | ---- | ---- | -------------------- |
| DIR_Name     | 0x00 | 11   | 文件名 8B，扩展名 3B |
| DIR_Attr     | 0x0B | 1    | 文件属性             |
| 保留         | 0x0C | 10   | 保留位               |
| DIR_WrtTime  | 0x16 | 2    | 最后一次写入时间     |
| DIR_WrtDate  | 0x18 | 2    | 最后一次写入日期     |
| DIR_FstCtus  | 0x1A | 2    | 起始簇号             |
| DIR_FileSize | 0x1C | 4    | 文件大小             |

其中 DIR_FstClus 字段描述的是文件在磁盘中存放的具体位置，由于 FAT[0] 和 FAT[1] 已明确其作用不能用于数据区的簇索引，因此这里的值不能取 0 或 1，有效值将从 2 开始。

根目录占用扇区数的计算方法为： (BPB_RootEntCnt * 32 + BPB_BytesPerSec - 1) / BPB_BytesPerSec = (224 * 32 + 512 - 1) / 512 = 14，根目录区的扇区起始号为 MBR + FAT[0] + FAT[1] = 1+ 9 + 9 = 19，数据区的扇区起始号为 Root + Sizeof( Root ) = 19 + 14 = 33。



# FAT16



# FAT32



# EXFAT

|标识|偏移量|类型|大小|默认值|描述|
|---|---|---|---|---|---|
||||||